---
title: "Louisiana profile"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## PPP State Profile

Your assignment is to explore a dataset of PPP loan applications for a particular state and to answer a series of questions that will help you summarize that state's loan applications. You will need to write R code to answer those questions. You also will bring in other data, including Census information, and you will be making graphics, including maps, to illustrate your findings.

The deliverable will be this R Markdown notebook and a data folder that you will receive with a state's loan application data. Place any other data you are using to answer the questions in the same data folder.

## Load libraries and establish settings

**Task** Create a codeblock and load appropriate packages and settings for this assignment.
```{r}
options(scipen=999)
library(tidyverse)
library(janitor)
library(lubridate)
library(ggrepel)
library(sf)
library(tigris)
library(tidycensus)
census_api_key("c84fed421923b886b2bbdab82b6838c9a11b8c44")
```
## Initial Exploration

**Q1.**. Write R code that generates some basic descriptive statistics that allows you to describe the applications from your state. This code should produce results that describe the data in different ways: how many applications there are, along with ways to understand the typical and most frequent values for columns you find interesting or newsworthy. You should produce at least five (5) descriptive statistics and write up a summary of the data using them.

**A1.** 

Initially, there seemed to be 217,334 PPP loan applications in Louisiana, however once I did some digging, there were at least 2 loan applications that were not from LA. One such loan showed a KY zip code and another showed an Italian zip code, taking the loan total to 217,332. I also found 70508 (Lafayette, LA) had the highest number of ppp loans with 3068 loans, followed by 70301 (Thibodaux, LA) and 70816 (Baton Rouge, LA) which were tied for second with 2968 loans. Interestingly, the zip code with the highest number of loans did not have the highest dollar amount of loans. 70508 was 3rd with $302,644,379 in total loans. The highest amount of loans was in 70130 (New Orleans) with $396,902,184. I also looked for any addresses with many loan applications. There were many addresses with multiple applications, but 8710 JEFFERSON HIGHWAY had the most with 76 loans applications registered to that address. After some research online, I found all of these are some sort of "Valman" or "ValCo" company out of Baton Rouge I googled the address and it is the physical building for the corporate address of Valluzzo Companies. 

I also explored NAICS codes. Naics code 812112 had the most loans with 14,578 loans. This code is for beauty salons. This code had nearly ten thousand more loans than any other. The second most common naics code was 541110 with 4,659 loans. This code is for offices of lawyers. The third most common loan was 722511, which is full-service restaraunts, that had 4631 loans. There were 58 naics codes with only 1 loan, including 111332 which is grape vinyards, 212113, which is anthracite mining, and 532220, which is formal wear and costume rental. I actually think looking at the least-common naics codes is more interesting. Naics code 921140 means "This industry comprises government establishments serving as councils and boards of commissioners or supervisors and such bodies where the chief executive (e.g., county executive or city mayor) is a member of the legislative body (e.g., county or city council) itself." This is odd, because woulnd't such people work for the government?

I also looked at jobs retained.  Most loans only retained one job, the second most loans retained two jobs, and so on until 10 and 9, which were flipped. Interestingly, there was 1 loan that retained 0 jobs but received $7,915. 

```{r}
la_ppp <- read_csv("louisiana_ppp.csv.zip") %>%
  clean_names()

#how many applications: 217334 minus 2 that are the wrong zip codes, so 217,332.

total_apps <- la_ppp %>%
  summarise(count=n())

#any loans with the same address?

address_la <-la_ppp %>%
  group_by(address) %>% summarise(total=n()) %>% arrange(desc(total))
#yes, tons. 8710 JEFFERSON HIGHWAY has 76 loans at that address apparently. 

jefferson_hwy <- la_ppp %>%
  filter(address == "8710 JEFFERSON HIGHWAY")
# all of these are some sort of "Valman" or "ValCo" company out of Baton Rouge I googled the address and it is the physical building for the corporate address of "Valluzzo Companies."

#sort by zip to see which zips have the highest average ppp loan amount and most loans
la_ppp_zip <- la_ppp %>%
    mutate(zip5 = str_sub(zip, start=1L, end=5L)) %>%
    group_by(zip5) %>%
    summarize(count=n()) %>%
    arrange(desc(count))
# 70508 (Lafayette, LA) had the highest number of ppp loans with 3068 loans, followed by 70301 (Thibodaux, LA) and 70816 (Baton Rouge, LA) which were tied for second with 2968 loans. Looking at the counties with the LEAST amount of loans, I found at least one error. The data included "NA," and also 40503, which is a Kentucky zip code. Another error was 70016 - which is an Italian zip code. 

#Next, I wanted to see if the zip codes with the most loans were also the zip codes with the highest dollar amounts
la_ppp_amount_zip <- la_ppp %>%
    mutate(zip5 = str_sub(zip, start=1L, end=5L)) %>%
    group_by(zip5) %>%
    summarise(
    total_loans = sum(amount),
    count=n()) %>%
  arrange(desc(total_loans))
#Interestingly, the zip code with the highest number of loans did not have the highest dollar amount of loans. 70508 was 3rd with $302,644,379 in total loans. The highest amount of loans was in 70130 (New Orleans) with $396,902,184. 

# Examine NAICS code 
naics_ppp <- la_ppp %>%
  group_by(naics_code) %>%
  summarize(count=n()) %>%
    arrange(desc(count))
#Naics code 812112 had the most loans with 14,578 loans. This code is for beauty salons. This code had nearly ten thousand more loans than any other. The second most common naics code was 541110 with 4,659 loans. This code is for offices of lawyers. The third most common loan was 722511, which is full-service restaraunts, that had 4631 loans. There were 58 naics codes with only 1 loan, including 111332 which is grape vinyards, 212113, which is anthracite mining, and 532220, which is formal wear and costume rental. I actually think looking at the least-common naics codes is more interesting. Naics code 921140 means "This industry comprises government establishments serving as councils and boards of commissioners or supervisors and such bodies where the chief executive (e.g., county executive or city mayor) is a member of the legislative body (e.g., county or city council) itself." This is odd, because woulnd't such people work for the government? 

#Also looking at jobs retained

jobs_retained <- la_ppp %>%
  group_by(jobs_retained) %>%
  summarize(count=n()) %>%
    arrange(desc(count))

# Most loans only retained one job, the second most loans retained two jobs, and so on until 10 and 9, which were flipped. Interestingly, there was 1 loan that retained 0 jobs but received $7,915. 
  
 
```
## Geographic Analysis

**Q2.** Write R code that examines geographic patterns for PPP loans in your state, using Census population information to calculate a per-capita figure for the state and counties and zip codes. 

Then, make a county map using ggplot showing the per-capita data and a zip code map showing the difference from the statewide per-capita figure. Describe the most interesting or newsworthy findings based on your exploration.

**A2.** 

In LA, counties are known as parishes. The parishes with the highest number of loans per capita were St. Helena and East Carroll parish. St. Helena is part of the Baton Rouge area. It is relatively small area. East Carroll is another small parish with less than 10,000 people. It is predominantly agricultural land located in the MI delta area.

The most interesting finding is that most counties are below state average of the number of loans per 100k, meaning most loans are concentrated in urban areas like New Orleans and Baton Rouge. 
```{r}
#2 different maps, one showing per-capita values by county and the 

#other with zip codes showing the _difference_ between the zip code per capita value and the statewide per capita value

#statewide per capita value


#PER CAPITA VALUES BY COUNTY
#this gets the census data and cleans it up
la_pop_county <- get_acs(geography = "county", 
              variables = c(population = "B01001_001"), 
              state = "LA",
              geometry = TRUE) %>%
      rename(project_county_name=NAME) %>%
      mutate(project_county_name = str_remove_all(project_county_name, "Parish|Louisiana|,")) %>%
      mutate(project_county_name = str_replace_all(project_county_name, "St.","Saint"))

  
#this is the ppp data
loans_per_county <- la_ppp %>%
   mutate(project_county_name = str_to_title(project_county_name)) %>%
  group_by(project_county_name) %>%
  summarise(total=n())

#join by project county name
joined_la_county <- la_pop_county %>%
  mutate(project_county_name = trimws(project_county_name)) %>%
    left_join(loans_per_county, by=c("project_county_name"="project_county_name")) %>%
  mutate(loans_per_100k = (total/estimate)*100000)
 #Saint Helena and East Carroll counties had the highest number of loans per capita

ggplot() + 
  geom_sf(data=joined_la_county, aes(fill=loans_per_100k)) + 
  theme_minimal() +
  scale_fill_viridis_b(option="magma",trans = "log") 

#state per capita loans
la_pop_state <- get_acs(geography = "state", 
              variables = c(population = "B01001_001"), 
              state = "LA",
              geometry = TRUE)
#217,332 loans/4,664,362 people)*100,000 is approximately 4659 loans per 100k

#pop by zip
la_pop_zip <- get_acs(geography = "zcta", 
              variables = c(population = "B01001_001"), 
              state = "LA",
              geometry = TRUE)

#loans by zip
loans_per_zip <- la_ppp %>%
  mutate(zip = str_sub(zip, start=1L, end=5L)) %>%
    group_by(zip) %>%
    summarise(total=n())
  
joined_la_zip <- la_pop_zip %>%
    left_join(loans_per_zip, by=c("GEOID"="zip")) %>%
    filter(estimate > 0) %>%
    mutate(per_100k = (total/estimate)*100000) %>%
    mutate(state_difference = (4659 - per_100k)) 



#ABS? How to I show the negative values?
ggplot() + 
  geom_sf(data=joined_la_zip, aes(fill = (state_difference))) + 
  theme_minimal() +
  scale_fill_viridis_b(option="magma",trans = "log") 

# The takeaway is that most of the counties have less than the state average of loans per capita, meaning most of the loans are concentrated in the urban areas - Baton Rouge, New Orleans areas.

```
## Lender Analysis

**Q3.** Write R code to examine which lenders had the most approved applications in your state (and include summary statistics such as total amount and average loan amount). Generate dataframes that show the number and total amount of all loans and undisbursed loans per lender. For those lenders who had any undisbursed loans, make a graphic showing the relationship between the total amount of loans and the total undisbursed amount. Describe the most noticeable outlier lenders on that graphic below.

**A3.** 
Prestamos CDFI, LLC is the lender with the most approved loans, with 21,251 and an average loan of $16,560. Capital Plus Financial, LLC had the second most with 16,110 approved loans at an average of $16,564. Neither Prestamos nor Capital Plus Financial had the highest amount of loans. Hancock Whitney Bank, which had the third most approved loans, had the highest amount of loans with $1,926,757,771 and an average loan of $149,755. They are the only lender with over $1 billion in loans. 

There were only 2 undisbursed loans.

Prestamos gave a LOT of lower-amount loans - more than any other lender, with over 15,000 loans between 10k and 50k.
```{r}
#most approved applications
approved_loans <- la_ppp %>%
  mutate(zip5 = str_sub(zip, start=1L, end=5L)) %>%
  group_by(lender) %>%
  summarize(count=n(), total_amount=sum(amount)) %>%
  mutate(average_amount = total_amount/count) %>%
  arrange(desc(count))

         
         # Prestamos CDFI, LLC is the lender with the most approved loans, with 21,251 and an average loan of $16,560. Capital Plus Financial, LLC had the second most with 16,110 approved loans at an average of $16,564. Neither Prestamos nor Capital Plus Financial had the highest amount of loans. Hancock Whitney Bank, which had the third most approved loans, had the highest amount of loans with $1,926,757,771 and an average loan of $149,755. They are the only lender with over $1 billion in loans. 

#undisbursed loans
undisbursed_loans <- la_ppp %>%
  mutate(zip5 = str_sub(zip, start=1L, end=5L),
         undisbursed = !is.na(undisbursed_amount) & undisbursed_amount > 0) %>%
  group_by(lender) %>%
  summarize(count=n(), total_amount=sum(amount), total_undisbursed_amount=sum(undisbursed_amount),
            undisbursed_n = sum(undisbursed))

la_ppp_totals <- la_ppp %>%
  group_by(lender, undisbursed_amount) %>%
  summarize(n = n())

#For those lenders who had any undisbursed loans, make a graphic showing the relationship between the total amount of loans and the total undisbursed amount. Describe the most noticeable outlier lenders on that graphic below.

undisbursed_lenders <- undisbursed_loans %>%
  filter(total_undisbursed_amount > 0)

write_csv(undisbursed_lenders, "undisbursed_lenders.csv")
# As there are only 2 undisbursed loans in the whole list, this graphic isn't very exciting.

#If there are no undisbursed loans, make graphic showing the relationship between lenders and loan amounts showing how many loans each lender issued for each amount in the dataframe. Describe the most noticeable outlier lenders on that graphic.

lender_relationship <- la_ppp %>%
  mutate(
    amount_bucket = case_when(
      amount < 10000 ~ 'under_10k',
    amount >= 10000 & amount < 50000 ~ '10k_to_50k',
    amount >= 50000 & amount < 100000 ~ '50k_to_100k',
    amount >= 100000 & amount < 500000 ~ '100k_to_500k',
    amount >= 500000 & amount < 1000000 ~ '500k_to_1m',
    amount >= 1000000 ~ '1m_plus')) %>%
  group_by(servicing_lender_name, amount_bucket) %>%
  summarize(count=n())

lender_relationship %>% 
  ggplot(aes(x=amount_bucket, y=count)) +
  geom_point() +
  geom_text(aes(label=ifelse(amount_bucket>10000, as.character(servicing_lender_name),"")), hjust=0, vjust=0)
  

#Prestamos gave a LOT of medium-amount loans - more than any other lender.

```

## Industry Analysis

**Q4.** Write R code that examines industry patterns for PPP loans in your state, using the NAICS codes from the PPP data as a starting point. Generate statewide and county industry totals, then join that with 2018-19 data from the [Census County Business Patterns survey](https://www2.census.gov/programs-surveys/cbp/datasets/2019/cbp19co.zip) using 6-digit NAICS codes. The documentation explaining that data can be found here: https://www2.census.gov/programs-surveys/cbp/technical-documentation/records-layouts/2018_record_layouts/county-layout-2018.txt. To do this, you will need to add FIPS codes to your PPP dataset.

Does the distribution of PPP applications by the top 10 industries (by number of applications) roughly match the number of businesses reported in the Census data? Does it roughly match if you remove self-employed individuals and sole proprietorships from the PPP totals? Write up a summary of what you've found and whether there are potentially newsworthy patterns in the data.

Create a county-level map showing the differences between the PPP applications and the Census business data for one of the top 10 industry codes. You can do this either using ggplot or Datawrapper (if the latter, publish that map and include the URL below).

**A4.** 
Honestly, I'm not sure if I called the data wrong or did something else incorrect, but I got WAY more ppp loans than registered businesses - nearly across the board. I chose to look at naics code 44 for the map (which is retail/trade), and I found that trend consistent. There were WAY more ppp loans than registered businesses - over 1,000 percent more in some counties. 
```{r}
#earlier analysis showed that most ppp loans in LA were beauty shops

#too big to load into github - this is the info by 
state_naics <- read_csv("census.txt") %>%
 filter(fipstate == "22") %>%
    mutate(naics_code = str_sub(naics, start=1L, end=2L)) %>%
  group_by(naics_code) %>%
  summarise(total_businesses=n()) 

naics_ppp_short <-naics_ppp %>%
   mutate(naics_code = str_sub(naics_code, start=1L, end=2L)) %>%
  rename(total_ppp_loans = count) %>%
  group_by(naics_code) %>%
  summarise(total_ppp_loans=n()) 

joined_naics <- naics_ppp_short %>%
  left_join(state_naics, by=c("naics_code"))

#sorting registered businesses by county code and naics
county_total_biz_by_naics <- read_csv("census.txt") %>%
  filter(fipstate == "22") %>%
    mutate(naics_code = str_sub(naics, start=1L, end=2L)) %>%
  group_by(naics_code, fipscty) %>%
  rename(county_code = fipscty) %>%
  summarise(total_businesses=n()) 

#sorting ppp by county code and naics
count_ppp_total_by_naics <- la_ppp %>%
  mutate(naics_code = str_sub(naics_code, start=1L, end=2L)) %>%
  rename(match_county = project_county_name) %>%
  group_by(naics_code, match_county) %>%
  summarise(total_ppp=n())

#read in county fips
la_county_fips <- read_csv("county_fips_copy.csv") %>%
  filter(state_code == "22") %>%
  dplyr::select(match_county, county_code)

#join county ppp and fips code
joined_county_naics <- count_ppp_total_by_naics %>%
  left_join(la_county_fips, by=c("match_county"))

### total pp loans with county code
### want to join total ppp loans with total businesses by county code
county_ppp_total_by_naics = left_join(la_county_fips, count_ppp_total_by_naics, by = c("match_county"))

nrow(county_ppp_total_by_naics)
nrow(county_total_biz_by_naics)

county_biz_ppp_naics = left_join(county_ppp_total_by_naics, county_total_biz_by_naics, by = c("county_code", "naics_code")) 

naics_44_map <- county_biz_ppp_naics %>%
  filter(naics_code == "44") %>%
  mutate(difference_percent=(total_ppp/total_businesses)*100)

la_pop_county_4 <- la_pop_county %>%
  mutate(project_county_name = trimws(toupper(project_county_name)))

naics_44 <- naics_44_map %>%
  left_join(la_pop_county_4, by = c("match_county" = "project_county_name"))

ggplot() + 
  geom_sf(data=naics_44, aes(geometry=geometry, fill = difference_percent)) + 
  theme_minimal() +
  scale_fill_viridis_b(option="magma",trans = "log") 

  #not sure if these numbers are correct



  

  

```
## Summary

**Q5.** What is the most promising story idea that you have found during this exploration? How would you approach reporting it out and what other information/data would you need to do that? What would be the minimum story you could get from this, and what would be the maximum story?

**A5.** I think some of the most promising stories could come from the initial analysis done in question 3 with the lenders. I think you could take that analysis further looking at when certain loans - or amounts of loans - were approved. Were there more smaller loans at one point in the program than another? You would have to choose a date range and look at which lenders gave the most loans - and how much the loans were for - during that time frame. You could plot this for a graphical representation. The minimum story would be, after a certain event, more low-dollar or high-dollar loans were approved. The maximum story would be maybe a lender stopped approving loans after a certain time OR peice of legislation was approved. For instance, if a lender stopped approving loans after the government pushed helping smaller businesses, that would be quite scandalous. 
```{r}

```